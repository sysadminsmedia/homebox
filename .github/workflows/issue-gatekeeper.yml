name: Issue Gatekeeper

permissions:
  issues: write

on:
  issues:
    types: [ opened ]

jobs:
  check-permissions:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Internal Template Use
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const actor = context.payload.sender.login;
            
            // 1. Get user permission level
            const { data: perms } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner,
              repo,
              username: actor
            });

            const isMember = ['admin', 'write'].includes(perms.permission);
            const labels = (context.payload.issue.labels || []).map(l => l.name);

            // Restrict use of the internal template to members (existing rule)
            const usedInternal = labels.includes('internal');
            if (usedInternal && !isMember) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: `@${actor}, the "Internal" template is restricted to project members. Please use one of the standard bug or feature templates for this repository.`
              });
              await github.rest.issues.update({ owner, repo, issue_number, state: 'closed' });
              return;
            }

            // 2. Enforce label rules based on creation date
            const isBug = labels.includes('ğŸ•·ï¸ bug');
            const hasInternal = usedInternal; // same as labels.includes('internal')
            const hasNoLabels = labels.length === 0;

            const createdAt = new Date(context.payload.issue.created_at);
            // Fixed threshold: First of January 2026 (UTC)
            const threshold = new Date(Date.UTC(2026, 0, 1));
            const afterThreshold = createdAt >= threshold;

            // Rule: Anything other than 'ğŸ•·ï¸ bug' must have 'internal' if created on/after 2026-01-01.
            // Also: No labels or missing 'internal' (when not bug) => close with message to use standard template.
            const violatesRule = afterThreshold && (!isBug && !hasInternal || hasNoLabels);

            if (violatesRule) {
              const reason = hasNoLabels
                ? `this issue has no labels`
                : `for non-\`ğŸ•·ï¸ bug\` issues the required \`internal\` label is missing`;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: `@${actor}, ${reason}. Please use one of the standard issue templates (bug or feature discussion).`
              });
              await github.rest.issues.update({ owner, repo, issue_number, state: 'closed' });
            }